name: Discord File Changes Notification

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get added files
        id: added
        run: |
          git fetch origin ${{ github.event.before }} --depth=1 || true
          ADDED=$(git diff --name-status ${{ github.event.before }} ${{ github.sha }} | grep '^A' | cut -f2)
          echo "added_files=$ADDED" >> $GITHUB_OUTPUT

      - name: Get modified files
        id: modified
        run: |
          git fetch origin ${{ github.event.before }} --depth=1 || true
          MODIFIED=$(git diff --name-status ${{ github.event.before }} ${{ github.sha }} | grep '^M' | cut -f2)
          echo "modified_files=$MODIFIED" >> $GITHUB_OUTPUT

      - name: Get removed files
        id: removed
        run: |
          git fetch origin ${{ github.event.before }} --depth=1 || true
          REMOVED=$(git diff --name-status ${{ github.event.before }} ${{ github.sha }} | grep '^D' | cut -f2)
          echo "removed_files=$REMOVED" >> $GITHUB_OUTPUT

      - name: Build Discord embed message
        id: message
        run: |
          REPO="${{ github.repository }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          ADDED_FILES="${{ steps.added.outputs.added_files }}"
          MODIFIED_FILES="${{ steps.modified.outputs.modified_files }}"
          REMOVED_FILES="${{ steps.removed.outputs.removed_files }}"

          EMBEDS="[]"

          # Create embed for Added files
          if [ -n "$ADDED_FILES" ]; then
            ADDED_JSON=$(jq -n \
              --arg title "ðŸŸ© Added files" \
              --arg desc "$ADDED_FILES" \
              --arg color "65280" \
              '{title:$title, description:("```\n"+$desc+"\n```"), color:($color|tonumber)}')
            EMBEDS=$(echo "$EMBEDS" | jq ". + [$ADDED_JSON]")
          fi

          # Create embed for Modified files
          if [ -n "$MODIFIED_FILES" ]; then
            MODIFIED_JSON=$(jq -n \
              --arg title "ðŸŸ¨ Modified files" \
              --arg desc "$MODIFIED_FILES" \
              --arg color "16776960" \
              '{title:$title, description:("```\n"+$desc+"\n```"), color:($color|tonumber)}')
            EMBEDS=$(echo "$EMBEDS" | jq ". + [$MODIFIED_JSON]")
          fi

          # Create embed for Removed files
          if [ -n "$REMOVED_FILES" ]; then
            REMOVED_JSON=$(jq -n \
              --arg title "ðŸŸ¥ Removed files" \
              --arg desc "$REMOVED_FILES" \
              --arg color "16711680" \
              '{title:$title, description:("```\n"+$desc+"\n```"), color:($color|tonumber)}')
            EMBEDS=$(echo "$EMBEDS" | jq ". + [$REMOVED_JSON]")
          fi

          # Main info embed (commit + author)
          MAIN_JSON=$(jq -n \
            --arg title "ðŸ“ Changes in '$REPO'" \
            --arg desc "**Commit:** [$COMMIT_MSG]($COMMIT_URL)\n**Author:** $AUTHOR" \
            --arg color "3447003" \
            '{title:$title, description:$desc, color:($color|tonumber)}')

          EMBEDS=$(echo "[$MAIN_JSON]" | jq ". + $EMBEDS")

          PAYLOAD=$(jq -n --argjson embeds "$EMBEDS" '{embeds:$embeds}')
          echo "discord_message=$PAYLOAD" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        if: steps.added.outputs.added_files != '' || steps.modified.outputs.modified_files != '' || steps.removed.outputs.removed_files != ''
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: ${{ steps.message.outputs.discord_message }}
