name: Discord File Changes Notification

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get file changes
        id: changes
        run: |
          git fetch origin ${{ github.event.before }} --depth=1 || true
          echo "added<<EOF" >> $GITHUB_OUTPUT
          git diff --name-status ${{ github.event.before }} ${{ github.sha }} | grep '^A' | cut -f2 || true
          echo "EOF" >> $GITHUB_OUTPUT

          echo "modified<<EOF" >> $GITHUB_OUTPUT
          git diff --name-status ${{ github.event.before }} ${{ github.sha }} | grep '^M' | cut -f2 || true
          echo "EOF" >> $GITHUB_OUTPUT

          echo "removed<<EOF" >> $GITHUB_OUTPUT
          git diff --name-status ${{ github.event.before }} ${{ github.sha }} | grep '^D' | cut -f2 || true
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build Discord embed message
        id: message
        run: |
          ADDED="${{ steps.changes.outputs.added }}"
          MODIFIED="${{ steps.changes.outputs.modified }}"
          REMOVED="${{ steps.changes.outputs.removed }}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          REPO="${{ github.repository }}"

          DESCRIPTION="**Commit:** [$COMMIT_MSG]($COMMIT_URL)\n**Author:** $AUTHOR"

          if [ -n "$ADDED" ]; then
            DESCRIPTION="$DESCRIPTION\n\nðŸŸ© **Added files:**\n\`\`\`\n$ADDED\n\`\`\`"
          fi
          if [ -n "$MODIFIED" ]; then
            DESCRIPTION="$DESCRIPTION\n\nðŸŸ¨ **Modified files:**\n\`\`\`\n$MODIFIED\n\`\`\`"
          fi
          if [ -n "$REMOVED" ]; then
            DESCRIPTION="$DESCRIPTION\n\nðŸŸ¥ **Removed files:**\n\`\`\`\n$REMOVED\n\`\`\`"
          fi

          # Escape the description for JSON
          EMBED_JSON=$(jq -n \
            --arg title "ðŸ“ Changes in '$REPO'" \
            --arg desc "$DESCRIPTION" \
            --arg url "$COMMIT_URL" \
            --arg author "$AUTHOR" \
            --arg time "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            '{
              username: "Captain Hook",
              embeds: [
                {
                  title: $title,
                  description: $desc,
                  url: $url,
                  color: 3447003,
                  footer: { text: "GitHub â†’ Discord Webhook" },
                  timestamp: $time
                }
              ]
            }')

          echo "embed_payload=$EMBED_JSON" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        if: steps.changes.outputs.added != '' || steps.changes.outputs.modified != '' || steps.changes.outputs.removed != ''
        run: |
          curl -H "Content-Type: application/json" \
               -d '${{ steps.message.outputs.embed_payload }}' \
               ${{ secrets.DISCORD_WEBHOOK }}
