name: Discord File Changes Notification

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get file changes
        id: changes
        run: |
          git fetch origin ${{ github.event.before }} --depth=1 || true
          echo "added<<EOF" >> $GITHUB_OUTPUT
          git diff --name-status ${{ github.event.before }} ${{ github.sha }} | grep '^A' | cut -f2 || true
          echo "EOF" >> $GITHUB_OUTPUT
          echo "modified<<EOF" >> $GITHUB_OUTPUT
          git diff --name-status ${{ github.event.before }} ${{ github.sha }} | grep '^M' | cut -f2 || true
          echo "EOF" >> $GITHUB_OUTPUT
          echo "removed<<EOF" >> $GITHUB_OUTPUT
          git diff --name-status ${{ github.event.before }} ${{ github.sha }} | grep '^D' | cut -f2 || true
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build Discord message
        id: message
        run: |
          ADDED="${{ steps.changes.outputs.added }}"
          MODIFIED="${{ steps.changes.outputs.modified }}"
          REMOVED="${{ steps.changes.outputs.removed }}"
          MSG="üìÅ **Changes in '${{ github.repository }}'**\n**Commit:** [${{ github.event.head_commit.message }}](${{ github.event.head_commit.url }})"
          if [ -n "$ADDED" ]; then
            MSG="$MSG\n\n**üü© Added files:**\n\`\`\`\n$ADDED\n\`\`\`"
          fi
          if [ -n "$MODIFIED" ]; then
            MSG="$MSG\n\n**üü® Modified files:**\n\`\`\`\n$MODIFIED\n\`\`\`"
          fi
          if [ -n "$REMOVED" ]; then
            MSG="$MSG\n\n**üü• Removed files:**\n\`\`\`\n$REMOVED\n\`\`\`"
          fi
          echo -e "discord_message<<EOF" >> $GITHUB_OUTPUT
          echo -e "$MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        if: steps.changes.outputs.added != '' || steps.changes.outputs.modified != '' || steps.changes.outputs.removed != ''
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: ${{ steps.message.outputs.discord_message }}
